function UnavailableCancelButton(){CloseUnavailableSetting();return false}function CloseUnavailableSetting(){$("#UnavailableRegisterBtn").unbind();$("#UnavailableSettingPopup").fadeOut(300);if(gSelectedChipId==C_NEWCHIPID)CreateFooterButton(C_FT_DISPTP_SELECTED,C_FT_BTNTP_REZ_NEW);else if(IsUnavailableArea(gSelectedChipId))CreateFooterButton(C_FT_DISPTP_SELECTED,C_FT_BTNTP_UNAVAILABLE);commonClearTimer();return false}
function UnavailableRegisterButton(){gUnavailableActiveIndicator.show();gUnavailableOverlay.show();commonRefreshTimer(ReDisplayUnavailableChip);var prms=CreateUnavailableCallBackRegistParam(C_SC3240701CALLBACK_REGISTER,gSelectedChipId);DoCallBack(C_CALLBACK_WND701,prms,SC3240701AfterCallBack,"UnavailableRegisterButton");return false}
function ShowUnavailableSetting(){try{gUnavailableActiveIndicator.hide();gUnavailableOverlay.hide();$("#UnavailableRegisterBtn").attr("disabled",false);$("#UnavailableSettingDetailContent>div").remove();var baseCtrl=$("#"+gSelectedChipId);SetUnavailablePopoverPosition(CalcUnavailablePopoverPosition(baseCtrl));$("#UnavailableSettingPopup").fadeIn(300);gUnavailableActiveIndicator.show();commonRefreshTimer(ReDisplayUnavailableChip);InitUnavailableSettingPage()}catch(e){if(gSelectedChipId==""){HideChipDetailPopup();
SetChipUnSelectedStatus();SetTableUnSelectedStatus()}}}function InitUnavailableSettingPage(){var prms=CreateUnavailableCallBackDisplayParam(C_SC3240701CALLBACK_CREATEDISP,gSelectedChipId);DoCallBack(C_CALLBACK_WND701,prms,SC3240701AfterCallBack,"CreateUnavailableChipPage")}
function CreateUnavailableCallBackDisplayParam(method,chipId){if(chipId==C_NEWCHIPID)var rtnVal={Method:method,StartIdleTime:gArrObjChip[C_NEWCHIPID].displayStartDate,FinishIdleTime:gArrObjChip[C_NEWCHIPID].displayEndDate,StallIdleId:0};else{var stallIdleId=right(chipId,chipId.length-C_UNAVALIABLECHIPID.length);var rtnVal={Method:method,StallIdleId:stallIdleId}}return rtnVal}
function CreateUnavailableCallBackRegistParam(method,chipId){var strStallId=getStallId(chipId);var rtnVal={Method:method,DlrCD:$("#hidDlrCD").val(),StrCD:$("#hidBrnCD").val(),ShowDate:$("#hidShowDate").val(),Account:icropScript.ui.account,StartIdleTime:smbScript.ConvertDateToString2(smbScript.changeStringToDateIcrop($("#StartIdleDateTimeSelector").get(0).value)),FinishIdleTime:smbScript.ConvertDateToString2(smbScript.changeStringToDateIcrop($("#FinishIdleDateTimeSelector").get(0).value)),IdleTime:$("#IdleTimeHidden").val(),
IdleMemo:$("#IdleMemoTxt").val(),ValidateCode:CheckUnavailableSettingInputValue()};if(chipId==C_NEWCHIPID){rtnVal.StallId=gArrObjChip[C_NEWCHIPID].stallId;rtnVal.RowLockVersion=gArrObjChip[C_NEWCHIPID].rowLockVersion}else{rtnVal.RowLockVersion=$("#"+chipId).data("ROW_LOCK_VERSION");var stallIdleId=right(chipId,chipId.length-C_UNAVALIABLECHIPID.length);rtnVal.StallIdleId=stallIdleId;rtnVal.StallId=right(strStallId,strStallId.length-8)}return rtnVal}
function getStallId(chipId){var nRow=GetRowNoByChipId(chipId);return $(".stallNo"+nRow)[0].id}function CheckUnavailableSettingInputValue(){var rtnVal=0;var startIdle=smbScript.changeStringToDateIcrop($("#StartIdleDateTimeSelector").get(0).value);var endIdle=smbScript.changeStringToDateIcrop($("#FinishIdleDateTimeSelector").get(0).value);if(!smbScript.CheckContextOfPlan(null,startIdle,endIdle,null))rtnVal=903;return rtnVal}
function IsMandatoryUnavailableSettingEmpty(){var rtnVal=false;var checkItem1=$("#StartIdleDateTimeLabel").text();var checkItem2=$("#FinishIdleDateTimeLabel").text();if(checkItem1==""||checkItem2=="")rtnVal=true;return rtnVal}
function SC3240701AfterCallBack(result,context){var jsonResult=JSON.parse(result);jsonResult.Contents=htmlDecode(jsonResult.Contents);jsonResult.Message=htmlDecode(jsonResult.Message);jsonResult.UnavailableChipJson=htmlDecode(jsonResult.UnavailableChipJson);commonClearTimer();if(jsonResult.Caller==C_SC3240701CALLBACK_CREATEDISP&&jsonResult.ResultCode==0){InitUnavailablePage(result,context);gUnavailableActiveIndicator.hide();gUnavailableOverlay.hide();AfterCallBack()}else if(jsonResult.ResultCode==
8){icropScript.ShowMessageBox(jsonResult.ResultCode,jsonResult.Message,"");CloseUnavailableSetting();SetTableUnSelectedStatus();SetChipUnSelectedStatus();ClearOperationList();ClickChangeDate(0)}else if(jsonResult.ResultCode!=0){icropScript.ShowMessageBox(jsonResult.ResultCode,jsonResult.Message,"");gUnavailableActiveIndicator.hide();gUnavailableOverlay.hide();AfterCallBack()}else{gUnavailableActiveIndicator.hide();gUnavailableOverlay.hide();CloseUnavailableSetting();var dtStartTime;var dtEndTime;
var dtShow=new Date($("#hidShowDate").val());var stallIdleList=$.parseJSON(jsonResult.UnavailableChipJson);for(var keyString in stallIdleList){dtStartTime=new Date(stallIdleList[keyString].IDLE_START_DATETIME);dtEndTime=new Date(stallIdleList[keyString].IDLE_END_DATETIME);if(gSelectedChipId==C_NEWCHIPID)$("#"+C_NEWCHIPID).remove();else if(gSelectedChipId==C_UNAVALIABLECHIPID+stallIdleList[keyString].STALL_IDLE_ID)$("#"+C_UNAVALIABLECHIPID+stallIdleList[keyString].STALL_IDLE_ID).remove();if(dtStartTime<
gEndWorkTime&&dtEndTime>gStartWorkTime)DrawUnavailableArea(stallIdleList[keyString].STALL_IDLE_ID,stallIdleList[keyString].STALL_ID,stallIdleList[keyString].IDLE_START_DATETIME,stallIdleList[keyString].IDLE_END_DATETIME,stallIdleList[keyString].ROW_LOCK_VERSION,stallIdleList[keyString].IDLE_MEMO);SetTableUnSelectedStatus();SetChipUnSelectedStatus()}AfterCallBack()}}
function InitUnavailablePage(result,context){var jsonResult=JSON.parse(result);SetUnavailableContents(jsonResult.Contents);commonClearTimer();$("#UnavailableSettingPopup .UnavailableEllipsis").CustomLabel({useEllipsis:true});$("#UnavailableSettingDetailContent").fingerScroll({action:"stop"});InitUnavailableTextArea($("#IdleMemoTxt"),$("#IdleMemoDt"));SetUnavailableSettingTextEvent();var timeSpan=smbScript.CalcTimeSpan(smbScript.changeStringToDateIcrop($("#StartIdleDateTimeSelector").get(0).value),
smbScript.changeStringToDateIcrop($("#FinishIdleDateTimeSelector").get(0).value));if(timeSpan!=null)$("#UnavailableWorkTimeHidden").val(timeSpan)}
function InitUnavailableTextArea(ctrlTa,ctrlDt){var settingHeight=0;var textArea=ctrlTa;var headerDt=ctrlDt;if(C_UNAVAILABLE_TA_DEFAULTHEIGHT<textArea.attr("scrollHeight")){settingHeight=textArea.attr("scrollHeight");$("#UnavailableSettingDetailContent").fingerScroll()}else settingHeight=C_UNAVAILABLE_TA_DEFAULTHEIGHT;textArea.height(settingHeight);headerDt.css("line-height",settingHeight+12+"px")}
function UnavailableTextArea(ctrlTa,ctrlDt){var textArea=ctrlTa;var headerDt=ctrlDt;textArea.height(C_UNAVAILABLE_TA_DEFAULTHEIGHT);var tmp_sh=textArea.attr("scrollHeight");while(tmp_sh>textArea.attr("scrollHeight")){tmp_sh=textArea.attr("scrollHeight");textarea[0].scrollHeight++}if(textArea.attr("scrollHeight")>textArea.attr("offsetHeight"))$("#UnavailableSettingDetailContent").fingerScroll();else if(textArea.attr("scrollHeight")==textArea.attr("offsetHeight"))$("#UnavailableSettingDetailContent").fingerScroll({action:"stop"});
if(textArea.attr("scrollHeight")>textArea.attr("offsetHeight")){textArea.height(textArea.attr("scrollHeight"));headerDt.css("line-height",textArea.attr("scrollHeight")+12+"px")}else headerDt.css("line-height",C_UNAVAILABLE_TA_DEFAULTHEIGHT+12+"px")}
function SetUnavailableContents(cbResult){var contents=$("<Div>").html(cbResult).text();var UnavailableChip=$(contents).find("#UnavailableSettingDetailContent");var UnavailableChipHidden=$(contents).find("#SC3240701HiddenArea");$("#UnavailableSettingDetailContent>div").remove();UnavailableChip.children("div").clone(true).appendTo("#UnavailableSettingDetailContent");$("#SC3240701HiddenArea>div").remove();UnavailableChipHidden.children("div").clone(true).appendTo("#SC3240701HiddenArea")}
function SetUnavailablePopoverPosition(ctrlPosition){$("#UnavailableSettingPopupContent").css("left",ctrlPosition.popX);$("#UnavailableSettingPopupContent").css("top",ctrlPosition.popY);$(".ArrowMask").css("left",ctrlPosition.arrowX);$(".ArrowMask").css("top",ctrlPosition.arrowY);$("#UnavailableActiveIndicator").css({"left":$("#UnavailableMyDataBoxDiv").outerWidth()/2});$("#UnavailableActiveIndicator").css({"top":$("#UnavailableMyDataBoxDiv").outerHeight()/2});gUnavailablePopX=ctrlPosition.popX}
function CalcUnavailablePopoverPosition(baseCtrl){var possibleDir={left:false,right:false};var ctrlPosition={popX:0,popY:0,arrowX:0,arrowY:0};var popDispLeftX=baseCtrl.offset().left-($("#UnavailableArrowMask").width()/2-3)-$("#UnavailableSettingPopupContent").width();var popDispRightX=baseCtrl.offset().left+baseCtrl.width()+($("#UnavailableArrowMask").width()/2-3);var temp=$("#UnavailableSettingPopupContent").width();if(popDispRightX+$("#UnavailableSettingPopupContent").width()<=$(document.body).width())possibleDir.right=
true;else if(0<=popDispLeftX)possibleDir.left=true;if(possibleDir.right){ctrlPosition.popX=popDispRightX;ctrlPosition.arrowX=C_SC3240701POP_DISPRIGHT_ARROW_X}else if(possibleDir.left){ctrlPosition.popX=popDispLeftX;ctrlPosition.arrowX=C_SC3240701POP_DISPLEFT_ARROW_X}else{ctrlPosition.popX=C_SC3240701POP_DISPRIGHT_DEFAULT_X;ctrlPosition.arrowX=C_SC3240701POP_DISPRIGHT_ARROW_X}ctrlPosition.arrowY=55;ctrlPosition.popY=baseCtrl.offset().top+baseCtrl.height()/2-115;if(ctrlPosition.popY<=0)ctrlPosition.popY=
0;var mainArea=document.getElementById("MainArea").offsetHeight;var popupHegiht=$("#UnavailableSettingPopupContent").height();if(ctrlPosition.popY+popupHegiht-mainArea>=0){ctrlPosition.popY=mainArea-popupHegiht;ctrlPosition.arrowY=baseCtrl.offset().top-ctrlPosition.popY-15;if(ctrlPosition.arrowY<0)ctrlPosition.arrowY=0}return ctrlPosition}
function ControlLengthTextarea(ta){var maxLen=ta.attr("maxlen");var overFlg=0;var v=ta.val();if(v.length>maxLen)var overFlg=1;if(overFlg=="1"){var AfterStr=v.substr(0,maxLen);ta.val(AfterStr)}};
